# 预警功能快速开始指南

## 架构说明

**重要**: 预警判断逻辑在后端处理,前端只负责样式应用!

- **后端**: 在`GetPageData`中判断数据是否需要预警,为数据添加`ShouldAlert`字段
- **前端**: 根据`ShouldAlert`字段应用黄色背景样式

## 5分钟快速上手

### 第一步: 配置预警规则

在数据库的`OCP_AlertRules`表中添加预警规则:

```sql
INSERT INTO OCP_AlertRules (
    RuleName,           -- 规则名称
    AlertPage,          -- 页面名称(如: OCP_TechManagement)
    FieldName,          -- 日期字段名(多个用逗号分隔)
    DayCount,           -- 超期天数阈值
    advanceWarningDays, -- 提前预警天数(可选)
    FinishStatusField,  -- 完成状态字段
    ConditionType,      -- 完成判定方式
    ConditionValue,     -- 完成判定值
    TaskStatus,         -- 任务状态(1=启用)
    CreateDate,
    Creator
) VALUES (
    'BOM创建超期预警',
    'OCP_TechManagement',
    'RequiredCompletionDate',
    2,
    0,
    'BOMCreateDate',
    '是否有值判断',
    '',
    1,
    GETDATE(),
    '系统管理员'
)
```

### 第二步: 为实体类添加ShouldAlert属性

打开实体类的partial文件,例如 `api\HDPro.Entity\DomainModels\OrderCollaboration\partial\OCP_TechManagement.cs`:

```csharp
public partial class OCP_TechManagement
{
    /// <summary>
    /// 预警标记(用于前端显示,不映射到数据库)
    /// </summary>
    [NotMapped]
    public bool ShouldAlert { get; set; }
}
```

### 第三步: 在Service中集成预警逻辑

打开Service文件,例如 `api\HDPro.CY.Order\Services\OrderCollaboration\Partial\OCP_TechManagementService.cs`:

#### 1. 添加using引用

```csharp
using HDPro.CY.Order.Services.Common;
```

#### 2. 在GetPageData的GetPageDataOnExecuted中调用

```csharp
GetPageDataOnExecuted = (PageGridData<OCP_TechManagement> grid) =>
{
    if (grid.rows != null && grid.rows.Any())
    {
        // 其他业务逻辑...

        // 应用预警标记
        ApplyAlertWarningToData(grid.rows);
    }
};
```

#### 3. 添加ApplyAlertWarningToData方法

```csharp
private void ApplyAlertWarningToData(List<OCP_TechManagement> list)
{
    try
    {
        var alertRulesService = AutofacContainerModule.GetService<IOCP_AlertRulesService>();
        var rules = alertRulesService.FindAsyncAsync(x =>
            x.AlertPage == "OCP_TechManagement" &&
            x.TaskStatus == 1).GetAwaiter().GetResult();

        if (rules != null && rules.Any())
        {
            AlertWarningHelper.ApplyAlertWarning(list, rules.ToList(), _logger);
        }
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "应用预警标记时发生异常");
    }
}
```

### 第四步: 在前端页面应用预警样式

打开Vue页面文件,例如 `OCP_TechManagement.vue`:

#### 1. 导入预警函数

```javascript
import { applyAlertWarningStyle } from '@/utils/alertWarning'
```

#### 2. 在searchAfter中应用

```javascript
const searchAfter = async (rows, result) => {
  // 应用预警样式(后端已经在数据中添加了ShouldAlert字段)
  applyAlertWarningStyle(columns)
  return true
}
```

### 第五步: 测试效果

1. 刷新页面
2. 查看表格中满足预警条件的行是否显示黄色背景

## 完整示例

### 示例1: 技术管理页面BOM创建预警

**需求**: 
- 监控`RequiredCompletionDate`(要求完成日期)字段
- 超过要求完成日期2天后显示预警
- 如果`BOMCreateDate`(BOM创建日期)有值,说明已完成,不预警

**配置**:
```sql
INSERT INTO OCP_AlertRules (
    RuleName, AlertPage, FieldName, DayCount, 
    FinishStatusField, ConditionType, ConditionValue, TaskStatus
) VALUES (
    'BOM创建超期预警',
    'OCP_TechManagement',
    'RequiredCompletionDate',
    2,
    'BOMCreateDate',
    '是否有值判断',
    '',
    1
)
```

**代码**:
```javascript
// OCP_TechManagement.vue
import { applyAlertWarningToColumns } from '@/composables/useAlertWarning'

const searchAfter = async (rows, result) => {
  await applyAlertWarningToColumns('OCP_TechManagement', columns)
  return true
}
```

### 示例2: 采购跟踪页面到货预警

**需求**:
- 监控`ExpectedArrivalDate`(预计到货日期)字段
- 在预计到货日期前3天开始预警
- 如果`ActualArrivalDate`(实际到货日期)有值,说明已到货,不预警

**配置**:
```sql
INSERT INTO OCP_AlertRules (
    RuleName, AlertPage, FieldName, DayCount, advanceWarningDays,
    FinishStatusField, ConditionType, ConditionValue, TaskStatus
) VALUES (
    '采购到货提前预警',
    'OCP_POUnFinishTrack',
    'ExpectedArrivalDate',
    0,
    3,
    'ActualArrivalDate',
    '是否有值判断',
    '',
    1
)
```

**代码**:
```javascript
// OCP_POUnFinishTrack.vue
import { applyAlertWarningToColumns } from '@/composables/useAlertWarning'

const searchAfter = async (rows, result) => {
  await applyAlertWarningToColumns('OCP_POUnFinishTrack', columns)
  return true
}
```

### 示例3: 自定义预警颜色

如果想使用红色背景而不是默认的黄色:

```javascript
const searchAfter = async (rows, result) => {
  await applyAlertWarningToColumns('OCP_TechManagement', columns, {
    backgroundColor: '#ffecec',
    color: '#f5222d'
  })
  return true
}
```

## 字段说明速查表

| 字段名 | 说明 | 示例值 |
|--------|------|--------|
| RuleName | 规则名称 | "BOM创建超期预警" |
| AlertPage | 页面名称(表名) | "OCP_TechManagement" |
| FieldName | 日期字段名 | "RequiredCompletionDate" |
| DayCount | 超期天数阈值 | 2 |
| advanceWarningDays | 提前预警天数 | 3 |
| FinishStatusField | 完成状态字段 | "BOMCreateDate" |
| ConditionType | 完成判定方式 | "是否有值判断" 或 "根据完成判定值来判断" |
| ConditionValue | 完成判定值 | "" 或 "已完成" |
| TaskStatus | 任务状态 | 1(启用) / 0(停止) / 2(暂停) |

## 常见问题

### Q1: 预警规则不生效?

**检查清单**:
1. 确认`TaskStatus`字段值为1(启用状态)
2. 确认`AlertPage`字段值与页面名称完全一致
3. 确认`FieldName`字段名与实体类属性名一致(区分大小写)
4. 刷新页面清除缓存

### Q2: 如何清除预警规则缓存?

```javascript
import { clearAlertRulesCache } from '@/utils/alertWarningHelper'

// 清除指定页面的缓存
clearAlertRulesCache('OCP_TechManagement')

// 或清除所有缓存
clearAlertRulesCache()
```

### Q3: 如何支持多个日期字段?

在`FieldName`字段中用逗号分隔多个字段名:

```sql
FieldName = 'RequiredCompletionDate,DeliveryDate,PlanFinishDate'
```

### Q4: 如何调试预警规则?

在浏览器控制台查看日志:

```javascript
// 会输出类似信息:
// "页面 OCP_TechManagement 加载了 2 条预警规则"
// "页面 OCP_TechManagement 应用了 2 条预警规则"
```

## 下一步

- 查看完整文档: `docs\预警功能使用说明.md`
- 了解技术细节: `README_预警功能开发总结.md`
- 扩展到更多页面: 重复上述步骤即可

## 技术支持

如有问题,请查看:
1. 浏览器控制台的错误信息
2. 后端日志
3. 预警规则配置是否正确

