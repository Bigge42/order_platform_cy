# 预警功能使用说明

## 功能概述

预警功能允许在表格页面中根据配置的预警规则自动为满足条件的行添加背景色,实现数据预警提示。

## 核心特性

1. **通用性强**: 一次开发,多页面复用
2. **配置化**: 通过预警规则表配置,无需修改代码
3. **灵活性**: 支持多种判断条件和日期计算
4. **性能优化**: 预警规则缓存机制,减少API调用

## 技术架构

### 后端部分

#### 1. 预警规则查询接口

**文件位置**: `api\HDPro.WebApi\Controllers\Order\Partial\OCP_AlertRulesController.cs`

**接口说明**:
```csharp
[HttpGet("GetAlertRulesByPage")]
public async Task<WebResponseContent> GetAlertRulesByPage(string pageName)
```

**功能**: 根据页面名称查询该页面所有启用状态的预警规则

**参数**:
- `pageName`: 页面名称(如: OCP_TechManagement)

**返回**: 预警规则列表

### 前端部分

#### 1. 预警工具类

**文件位置**: `web.vite\src\utils\alertWarningHelper.js`

**核心函数**:

- `getAlertRulesByPage(pageName)`: 获取指定页面的预警规则
- `clearAlertRulesCache(pageName)`: 清除预警规则缓存
- `applyAlertWarningStyle(columns, alertRules, customStyle)`: 应用预警样式到表格列

#### 2. 组合式函数

**文件位置**: `web.vite\src\composables\useAlertWarning.js`

**核心函数**:

- `useAlertWarning(pageName, columns, options)`: 完整的预警功能组合式函数
- `applyAlertWarningToColumns(pageName, columns, customStyle)`: 简化版预警功能

## 使用方法

### 方法一: 在searchAfter中使用(推荐)

这是最简单的使用方式,适合大多数场景。

```javascript
import { applyAlertWarningToColumns } from '@/composables/useAlertWarning'

const searchAfter = async (rows, result) => {
  // 应用预警样式
  await applyAlertWarningToColumns('OCP_TechManagement', columns)
  return true
}
```

### 方法二: 使用组合式函数

适合需要更多控制的场景。

```javascript
import { useAlertWarning } from '@/composables/useAlertWarning'

const onInit = async ($vm) => {
  gridRef = $vm
  
  // 使用预警功能
  const { loadAlertRules, refreshAlertRules } = useAlertWarning(
    'OCP_TechManagement', 
    columns,
    {
      customStyle: {
        backgroundColor: '#fffbe6',
        color: '#000'
      },
      autoLoad: false // 不自动加载,手动控制
    }
  )
  
  // 在需要的时候加载预警规则
  await loadAlertRules()
}
```

### 方法三: 自定义样式

```javascript
const searchAfter = async (rows, result) => {
  // 使用自定义预警样式
  await applyAlertWarningToColumns('OCP_TechManagement', columns, {
    backgroundColor: '#ffecec',
    color: '#f5222d'
  })
  return true
}
```

## 预警规则配置

在`OCP_AlertRules`表中配置预警规则:

### 字段说明

- **AlertPage**: 预警页面名称(如: OCP_TechManagement)
- **FieldName**: 日期字段名(多个字段用逗号分隔)
- **DayCount**: 阈值天数(超过目标日期多少天开始预警)
- **advanceWarningDays**: 提前预警天数(在目标日期前多少天开始预警)
- **FinishStatusField**: 完成状态字段
- **ConditionType**: 完成判定方式
  - "根据完成判定值来判断": 字段值等于ConditionValue时视为已完成
  - "是否有值判断": 字段有值时视为已完成
- **ConditionValue**: 完成判定值
- **TaskStatus**: 任务状态(1=启用, 0=停止, 2=暂停)

### 配置示例

#### 示例1: 技术管理BOM创建预警

```sql
INSERT INTO OCP_AlertRules (
    RuleName, 
    AlertPage, 
    FieldName, 
    DayCount, 
    advanceWarningDays,
    FinishStatusField, 
    ConditionType, 
    ConditionValue,
    TaskStatus
) VALUES (
    'BOM创建超期预警',
    'OCP_TechManagement',
    'RequiredCompletionDate',
    2,
    0,
    'BOMCreateDate',
    '是否有值判断',
    '',
    1
)
```

**说明**: 
- 监控`RequiredCompletionDate`字段
- 超过要求完成日期2天后预警
- 如果`BOMCreateDate`有值,说明已完成,不预警

## 预警判断逻辑

1. **完成状态检查**: 首先检查完成状态字段,如果已完成则不预警
2. **日期超期检查**: 检查日期字段是否超过阈值天数
3. **提前预警检查**: 如果设置了提前预警天数,在目标日期前N天开始预警

## 注意事项

1. **页面名称**: 必须与表名一致
2. **字段名称**: 必须与实体类属性名一致(区分大小写)
3. **缓存机制**: 预警规则会被缓存,如果修改了规则,需要刷新页面或调用`clearAlertRulesCache()`
4. **性能考虑**: 预警规则在每次查询后应用,不会影响查询性能

## 扩展其他页面

要在其他页面应用预警功能,只需:

1. 在页面的`searchAfter`方法中添加一行代码:
```javascript
await applyAlertWarningToColumns('页面名称', columns)
```

2. 在`OCP_AlertRules`表中配置该页面的预警规则

就这么简单!

