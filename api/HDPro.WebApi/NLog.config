<?xml version="1.0" encoding="utf-8" ?>
<nlog xmlns="http://www.nlog-project.org/schemas/NLog.xsd"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      autoReload="true"
      internalLogLevel="Info"
      internalLogFile="logs/internal-nlog.txt">

  <!-- 启用ASP.NET Core布局渲染器 -->
  <extensions>
    <add assembly="NLog.Web.AspNetCore"/>
  </extensions>

  <!-- 定义日志输出目标 -->
  <targets>
    <!-- 所有日志文件 -->
    <target xsi:type="File" name="allfile" fileName="logs/nlog-all-${shortdate}.log"
            layout="${longdate}|${event-properties:item=EventId_Id}|${uppercase:${level}}|${logger}|${message} ${exception:format=tostring}"
            concurrentWrites="true"
            keepFileOpen="false"
            openFileCacheTimeout="30"
            cleanupFileName="false"
            enableFileDelete="true" />

    <!-- 应用程序日志文件（排除Microsoft日志） -->
    <target xsi:type="File" name="ownFile-web" fileName="logs/nlog-own-${shortdate}.log"
            layout="${longdate}|${event-properties:item=EventId_Id}|${uppercase:${level}}|${logger}|${message} ${exception:format=tostring}|url: ${aspnet-request-url}|action: ${aspnet-mvc-action}"
            concurrentWrites="true"
            keepFileOpen="false"
            openFileCacheTimeout="30"
            cleanupFileName="false"
            enableFileDelete="true" />

    <!-- 错误日志文件 -->
    <target xsi:type="File" name="errorFile" fileName="logs/nlog-error-${shortdate}.log"
            layout="${longdate}|${event-properties:item=EventId_Id}|${uppercase:${level}}|${logger}|${message} ${exception:format=tostring}|url: ${aspnet-request-url}|action: ${aspnet-mvc-action}"
            concurrentWrites="true"
            keepFileOpen="false"
            openFileCacheTimeout="30"
            cleanupFileName="false"
            enableFileDelete="true" />

    <!-- 信息日志文件 -->
    <target xsi:type="File" name="infoFile" fileName="logs/nlog-info-${shortdate}.log"
            layout="${longdate}|${event-properties:item=EventId_Id}|${uppercase:${level}}|${logger}|${message} ${exception:format=tostring}|url: ${aspnet-request-url}|action: ${aspnet-mvc-action}"
            concurrentWrites="true"
            keepFileOpen="false"
            openFileCacheTimeout="30"
            cleanupFileName="false"
            enableFileDelete="true" />

    <!-- 物料同步专用日志文件 -->
    <target xsi:type="File" name="materialSyncFile" fileName="logs/物料同步-${shortdate}.log"
            layout="${longdate}|${uppercase:${level}}|${message} ${exception:format=tostring}"
            concurrentWrites="true"
            keepFileOpen="false"
            openFileCacheTimeout="30"
            cleanupFileName="false"
            enableFileDelete="true"
            archiveEvery="Day"
            archiveNumbering="Rolling"
            maxArchiveFiles="30"
            encoding="utf-8" />

    <!-- ESB普通日志文件 -->
    <target xsi:type="File" name="esbInfoFile" fileName="logs/${shortdate}/ESB-信息-${shortdate}.log"
            layout="${longdate}|${uppercase:${level}}|${message} ${exception:format=tostring}"
            concurrentWrites="true"
            keepFileOpen="false"
            openFileCacheTimeout="30"
            cleanupFileName="false"
            enableFileDelete="true"
            archiveEvery="Day"
            archiveNumbering="Rolling"
            maxArchiveFiles="30"
            encoding="utf-8" />

    <!-- ESB错误日志文件 -->
    <target xsi:type="File" name="esbErrorFile" fileName="logs/${shortdate}/ESB-错误-${shortdate}.log"
            layout="${longdate}|${uppercase:${level}}|${message} ${exception:format=tostring}"
            concurrentWrites="true"
            keepFileOpen="false"
            openFileCacheTimeout="30"
            cleanupFileName="false"
            enableFileDelete="true"
            archiveEvery="Day"
            archiveNumbering="Rolling"
            maxArchiveFiles="30"
            encoding="utf-8" />

    <!-- OA普通日志文件 -->
    <target xsi:type="File" name="oaInfoFile" fileName="logs/${shortdate}/OA-信息-${shortdate}.log"
            layout="${longdate}|${uppercase:${level}}|${message} ${exception:format=tostring}"
            concurrentWrites="true"
            keepFileOpen="false"
            openFileCacheTimeout="30"
            cleanupFileName="false"
            enableFileDelete="true"
            archiveEvery="Day"
            archiveNumbering="Rolling"
            maxArchiveFiles="30"
            encoding="utf-8" />

    <!-- OA错误日志文件 -->
    <target xsi:type="File" name="oaErrorFile" fileName="logs/${shortdate}/OA-错误-${shortdate}.log"
            layout="${longdate}|${uppercase:${level}}|${message} ${exception:format=tostring}"
            concurrentWrites="true"
            keepFileOpen="false"
            openFileCacheTimeout="30"
            cleanupFileName="false"
            enableFileDelete="true"
            archiveEvery="Day"
            archiveNumbering="Rolling"
            maxArchiveFiles="30"
            encoding="utf-8" />

    <!-- 控制台输出 -->
    <target xsi:type="Console" name="lifetimeConsole" layout="${level:truncate=4:lowercase=true}: ${logger}[0]${newline}      ${message}${exception:format=tostring}" />
  </targets>

  <!-- 定义日志记录规则 -->
  <rules>
    <!-- 物料同步专用日志规则 -->
    <logger name="MaterialSync" minlevel="Trace" writeTo="materialSyncFile" final="true" />

    <!-- ESB专用日志规则 -->
    <logger name="ESB.*" minlevel="Error" writeTo="esbErrorFile" />
    <logger name="ESB.*" minlevel="Trace" maxlevel="Warn" writeTo="esbInfoFile" final="true" />

    <!-- OA专用日志规则 -->
    <logger name="OA.*" minlevel="Error" writeTo="oaErrorFile" />
    <logger name="OA.*" minlevel="Trace" maxlevel="Warn" writeTo="oaInfoFile" final="true" />
    
    <!-- 所有日志写入到allfile -->
    <logger name="*" minlevel="Trace" writeTo="allfile" />

    <!-- 跳过Microsoft的非关键日志，提高性能 -->
    <logger name="Microsoft.*" maxlevel="Info" final="true" />
    <logger name="System.Net.Http.*" maxlevel="Info" final="true" />

    <!-- 应用程序日志写入到ownFile-web -->
    <logger name="*" minlevel="Trace" writeTo="ownFile-web" />

    <!-- 错误日志单独记录 -->
    <logger name="*" minlevel="Error" writeTo="errorFile" />

    <!-- 信息日志单独记录 -->
    <logger name="*" minlevel="Info" maxlevel="Info" writeTo="infoFile" />

    <!-- 生命周期消息输出到控制台 -->
    <logger name="Microsoft.Hosting.Lifetime" minlevel="Info" writeTo="lifetimeConsole" final="true" />
  </rules>
</nlog> 