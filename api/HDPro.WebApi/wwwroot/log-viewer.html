<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥å¿—æŸ¥çœ‹å™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            margin-bottom: 10px;
        }

        .auth-section {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }

        .auth-form {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .auth-form input {
            flex: 1;
            min-width: 200px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            margin-right: 10px;
        }

        .auth-form input:last-of-type {
            margin-right: 0;
        }

        #userInfo {
            font-weight: bold;
            color: #28a745;
            margin-right: 15px;
        }

        .verification-code {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .verification-code input {
            flex: 1;
            margin-right: 0;
        }

        .verification-code img {
            flex-shrink: 0;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
        }

        .content {
            padding: 20px;
        }

        .file-list {
            margin-bottom: 20px;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 5px;
            margin-bottom: 10px;
            background: #f8f9fa;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-weight: bold;
            color: #333;
        }

        .file-meta {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .file-actions {
            display: flex;
            gap: 5px;
        }

        .log-viewer {
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #f8f9fa;
            max-height: 500px;
            overflow-y: auto;
        }

        .log-header {
            background: #e9ecef;
            padding: 10px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: between;
            align-items: center;
            gap: 10px;
        }

        .log-content {
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
            white-space: pre-wrap;
            background: #fff;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .search-box {
            margin-bottom: 10px;
        }

        .search-box input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        /* æ–‡ä»¶åˆ—è¡¨æœç´¢å’Œè¿‡æ»¤ */
        .file-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .file-search {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
            min-width: 300px;
        }

        .file-search input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .file-stats {
            font-size: 14px;
            color: #666;
            white-space: nowrap;
        }

        .file-filters {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 6px 12px;
            border: 1px solid #ddd;
            background: #f8f9fa;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            background: #e9ecef;
        }

        .filter-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        /* è¯¦æƒ…é¡µé¢æ ·å¼ */
        .log-detail-page {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .detail-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .detail-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .detail-title h3 {
            margin: 0;
            color: #333;
            font-size: 18px;
        }

        .detail-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .detail-info {
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .file-metadata {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            font-size: 14px;
        }

        .metadata-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .metadata-label {
            font-weight: bold;
            color: #666;
            font-size: 12px;
            text-transform: uppercase;
        }

        .metadata-value {
            color: #333;
            font-family: 'Courier New', monospace;
        }

        .detail-content {
            padding: 20px;
        }

        .content-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .search-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex: 1;
            min-width: 300px;
        }

        .search-controls input {
            flex: 1;
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .view-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .view-controls label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            cursor: pointer;
        }

        .view-controls select {
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .log-content-wrapper {
            border: 1px solid #ddd;
            border-radius: 5px;
            max-height: 600px;
            overflow-y: auto;
            background: #f8f9fa;
        }

        .log-content {
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
            white-space: pre-wrap;
            word-break: break-all;
            background: white;
            min-height: 400px;
        }

        .page-jump {
            display: flex;
            gap: 5px;
            align-items: center;
            margin-left: 15px;
        }

        .page-jump input {
            width: 80px;
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
        }

        /* é«˜äº®æœç´¢ç»“æœ */
        .search-highlight {
            background-color: #ffeb3b;
            padding: 1px 2px;
            border-radius: 2px;
        }

        /* æ–‡ä»¶é¡¹ä¼˜åŒ– */
        .file-item {
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }

        .file-item:hover {
            border-left-color: #007bff;
            background: #f8f9fa;
        }

        .file-item.hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .auth-form {
                flex-direction: column;
            }

            .auth-form input {
                min-width: 100%;
            }

            .file-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .file-actions {
                width: 100%;
                justify-content: flex-end;
            }

            .file-list-header {
                flex-direction: column;
                align-items: stretch;
            }

            .file-search {
                min-width: auto;
            }

            .detail-header {
                flex-direction: column;
                align-items: stretch;
            }

            .content-toolbar {
                flex-direction: column;
                align-items: stretch;
            }

            .search-controls {
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“‹ æ—¥å¿—æŸ¥çœ‹å™¨</h1>
            <p>å®‰å…¨çš„æ—¥å¿—æ–‡ä»¶ç®¡ç†å’ŒæŸ¥çœ‹å·¥å…·</p>
        </div>

        <div class="auth-section" id="loginSection">
            <div class="auth-form">
                <input type="text" id="usernameInput" placeholder="ç”¨æˆ·å" />
                <input type="password" id="passwordInput" placeholder="å¯†ç " />
                <div class="verification-code">
                    <input type="text" id="verificationCodeInput" placeholder="éªŒè¯ç " maxlength="6" />
                    <img id="verificationCodeImg" src="" alt="éªŒè¯ç " onclick="refreshVerificationCode()" style="cursor: pointer; height: 40px; border: 1px solid #ddd; border-radius: 5px;" />
                </div>
                <button class="btn btn-primary" onclick="login()">ğŸ” ç™»å½•</button>
            </div>
        </div>

        <div class="auth-section" id="loggedInSection" style="display: none;">
            <div class="auth-form">
                <span id="userInfo">æ¬¢è¿ï¼Œç”¨æˆ·</span>
                <button class="btn btn-info" onclick="refreshFiles()">ğŸ”„ åˆ·æ–°æ–‡ä»¶åˆ—è¡¨</button>
                <button class="btn btn-danger" onclick="logout()">ğŸšª é€€å‡ºç™»å½•</button>
            </div>
        </div>

        <div class="content">
            <div id="status"></div>

            <div class="file-list">
                <div class="file-list-header">
                    <h3>ğŸ“ æ—¥å¿—æ–‡ä»¶åˆ—è¡¨</h3>
                    <div class="file-search">
                        <input type="text" id="fileSearchInput" placeholder="ğŸ” æœç´¢æ–‡ä»¶å..." onkeyup="filterFiles()" />
                        <div class="file-stats">
                            <span id="fileStats">æ€»è®¡: 0 ä¸ªæ–‡ä»¶</span>
                        </div>
                    </div>
                </div>
                <div class="file-filters">
                    <button class="filter-btn active" onclick="filterByType('all')">å…¨éƒ¨</button>
                    <button class="filter-btn" onclick="filterByType('error')">é”™è¯¯æ—¥å¿—</button>
                    <button class="filter-btn" onclick="filterByType('info')">ä¿¡æ¯æ—¥å¿—</button>
                    <button class="filter-btn" onclick="filterByType('app')">åº”ç”¨æ—¥å¿—</button>
                </div>
                <div id="fileList">
                    <p>è¯·å…ˆç™»å½•...</p>
                </div>
            </div>

            <!-- è¯¦æƒ…é¡µé¢æ¨¡å¼ -->
            <div class="log-detail-page" id="logDetailPage" style="display: none;">
                <div class="detail-header">
                    <div class="detail-title">
                        <button class="btn btn-secondary" onclick="backToFileList()">â¬…ï¸ è¿”å›åˆ—è¡¨</button>
                        <h3 id="detailFileName">æ–‡ä»¶è¯¦æƒ…</h3>
                    </div>
                    <div class="detail-actions">
                        <button class="btn btn-info" onclick="downloadCurrentFile()">ğŸ“¥ ä¸‹è½½</button>
                        <button class="btn btn-success" onclick="refreshCurrentFile()">ğŸ”„ åˆ·æ–°</button>
                        <button class="btn btn-warning" onclick="toggleViewMode()">ğŸ“‹ åˆ‡æ¢è§†å›¾</button>
                    </div>
                </div>
                
                <div class="detail-info">
                    <div class="file-metadata" id="fileMetadata">
                        <!-- æ–‡ä»¶å…ƒæ•°æ®ä¿¡æ¯ -->
                    </div>
                </div>

                <div class="detail-content">
                    <div class="content-toolbar">
                        <div class="search-controls">
                            <input type="text" id="contentSearchInput" placeholder="ğŸ” æœç´¢æ—¥å¿—å†…å®¹..." />
                            <button class="btn btn-primary" onclick="searchInContent()">æœç´¢</button>
                            <button class="btn btn-secondary" onclick="clearContentSearch()">æ¸…é™¤</button>
                        </div>
                        <div class="view-controls">
                            <label>
                                <input type="checkbox" id="autoRefresh" onchange="toggleAutoRefresh()"> è‡ªåŠ¨åˆ·æ–°
                            </label>
                            <select id="pageSizeSelect" onchange="changePageSize()">
                                <option value="50">50è¡Œ/é¡µ</option>
                                <option value="100" selected>100è¡Œ/é¡µ</option>
                                <option value="200">200è¡Œ/é¡µ</option>
                                <option value="500">500è¡Œ/é¡µ</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="log-content-wrapper">
                        <div class="log-content" id="logContent"></div>
                    </div>
                    
                    <div class="pagination">
                        <button class="btn btn-primary" onclick="previousPage()">â¬…ï¸ ä¸Šä¸€é¡µ</button>
                        <span id="pageInfo">ç¬¬ 1 é¡µ</span>
                        <button class="btn btn-primary" onclick="nextPage()">â¡ï¸ ä¸‹ä¸€é¡µ</button>
                        <div class="page-jump">
                            <input type="number" id="pageJumpInput" placeholder="é¡µç " min="1" />
                            <button class="btn btn-secondary" onclick="jumpToPage()">è·³è½¬</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ä¼ ç»ŸæŸ¥çœ‹å™¨æ¨¡å¼ï¼ˆä¿ç•™å…¼å®¹æ€§ï¼‰ -->
            <div class="log-viewer" id="logViewer" style="display: none;">
                <div class="log-header">
                    <span id="currentFile">å½“å‰æ–‡ä»¶: æ— </span>
                    <div>
                        <button class="btn btn-info" onclick="downloadCurrentFile()">ğŸ“¥ ä¸‹è½½</button>
                        <button class="btn btn-danger" onclick="closeLogViewer()">âŒ å…³é—­</button>
                    </div>
                </div>
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="æœç´¢æ—¥å¿—å†…å®¹..." onkeyup="searchLogs()" />
                </div>
                <div class="log-content" id="logContentOld"></div>
                <div class="pagination">
                    <button class="btn btn-primary" onclick="previousPage()">â¬…ï¸ ä¸Šä¸€é¡µ</button>
                    <span id="pageInfoOld">ç¬¬ 1 é¡µ</span>
                    <button class="btn btn-primary" onclick="nextPage()">â¡ï¸ ä¸‹ä¸€é¡µ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let authToken = '';
        let currentFileName = '';
        let currentPage = 1;
        let totalPages = 1;
        let searchKeyword = '';
        let currentUser = '';
        let verificationUUID = '';
        let allFiles = []; // å­˜å‚¨æ‰€æœ‰æ–‡ä»¶æ•°æ®
        let filteredFiles = []; // å­˜å‚¨è¿‡æ»¤åçš„æ–‡ä»¶æ•°æ®
        let currentFilter = 'all'; // å½“å‰è¿‡æ»¤ç±»å‹
        let autoRefreshInterval = null; // è‡ªåŠ¨åˆ·æ–°å®šæ—¶å™¨
        let currentPageSize = 100; // å½“å‰é¡µé¢å¤§å°
        let isDetailMode = true; // æ˜¯å¦ä½¿ç”¨è¯¦æƒ…é¡µé¢æ¨¡å¼

        const API_BASE = '/api/LogViewer';
        const AUTH_API = '/api/User';

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 5000);
        }

        async function refreshVerificationCode() {
            try {
                const response = await fetch(`${AUTH_API}/getVierificationCode`, {
                    method: 'GET'
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.img && data.uuid) {
                        document.getElementById('verificationCodeImg').src = `data:image/png;base64,${data.img}`;
                        verificationUUID = data.uuid;
                    } else {
                        showStatus('è·å–éªŒè¯ç å¤±è´¥', 'error');
                    }
                } else {
                    showStatus('è·å–éªŒè¯ç å¤±è´¥', 'error');
                }
            } catch (error) {
                showStatus(`è·å–éªŒè¯ç å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function login() {
            const username = document.getElementById('usernameInput').value.trim();
            const password = document.getElementById('passwordInput').value.trim();
            const verificationCode = document.getElementById('verificationCodeInput').value.trim();
            
            if (!username || !password) {
                showStatus('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ', 'error');
                return;
            }

            if (!verificationCode) {
                showStatus('è¯·è¾“å…¥éªŒè¯ç ', 'error');
                return;
            }

            if (!verificationUUID) {
                showStatus('è¯·å…ˆè·å–éªŒè¯ç ', 'error');
                refreshVerificationCode();
                return;
            }

            try {
                showStatus('æ­£åœ¨ç™»å½•...', 'info');
                
                const response = await fetch(`${AUTH_API}/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userName: username,
                        password: password,
                        verificationCode: verificationCode,
                        uuid: verificationUUID
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.status && data.data && data.data.token) {
                        authToken = data.data.token;
                        currentUser = data.data.userName || username;
                        
                        // ä¿å­˜åˆ°localStorage
                        localStorage.setItem('authToken', authToken);
                        localStorage.setItem('currentUser', currentUser);
                        
                        showLoginSuccess();
                        showStatus('ç™»å½•æˆåŠŸï¼Œæ­£åœ¨åŠ è½½æ–‡ä»¶åˆ—è¡¨...', 'success');
                        refreshFiles();
                    } else {
                        showStatus(data.message || 'ç™»å½•å¤±è´¥', 'error');
                        // ç™»å½•å¤±è´¥æ—¶åˆ·æ–°éªŒè¯ç 
                        refreshVerificationCode();
                    }
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    showStatus(errorData.message || `ç™»å½•å¤±è´¥: HTTP ${response.status}`, 'error');
                    // ç™»å½•å¤±è´¥æ—¶åˆ·æ–°éªŒè¯ç 
                    refreshVerificationCode();
                }
            } catch (error) {
                showStatus(`ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
            }
        }

        function showLoginSuccess() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('loggedInSection').style.display = 'block';
            document.getElementById('userInfo').textContent = `æ¬¢è¿ï¼Œ${currentUser}`;
        }

        function logout() {
            authToken = '';
            currentUser = '';
            currentFileName = '';
            
            // æ¸…é™¤localStorage
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            
            // æ˜¾ç¤ºç™»å½•ç•Œé¢
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('loggedInSection').style.display = 'none';
            
            // æ¸…ç©ºæ–‡ä»¶åˆ—è¡¨
            document.getElementById('fileList').innerHTML = '<p>è¯·å…ˆç™»å½•...</p>';
            document.getElementById('logViewer').style.display = 'none';
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('usernameInput').value = '';
            document.getElementById('passwordInput').value = '';
            document.getElementById('verificationCodeInput').value = '';
            
            // é‡æ–°è·å–éªŒè¯ç 
            refreshVerificationCode();
            
            showStatus('å·²é€€å‡ºç™»å½•', 'info');
        }

        function checkStoredAuth() {
            const storedToken = localStorage.getItem('authToken');
            const storedUser = localStorage.getItem('currentUser');
            
            if (storedToken && storedUser) {
                authToken = storedToken;
                currentUser = storedUser;
                showLoginSuccess();
                showStatus('å·²è‡ªåŠ¨ç™»å½•ï¼Œæ­£åœ¨åŠ è½½æ–‡ä»¶åˆ—è¡¨...', 'success');
                refreshFiles();
            }
        }

        async function refreshFiles() {
            if (!authToken) {
                showStatus('è¯·å…ˆç™»å½•', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/files`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    allFiles = data.files || [];
                    applyFilters();
                    showStatus(`æˆåŠŸåŠ è½½ ${data.count || 0} ä¸ªæ—¥å¿—æ–‡ä»¶`, 'success');
                } else if (response.status === 401) {
                    showStatus('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•', 'error');
                    logout();
                } else {
                    const error = await response.text();
                    showStatus(`åŠ è½½æ–‡ä»¶åˆ—è¡¨å¤±è´¥: ${error}`, 'error');
                }
            } catch (error) {
                showStatus(`ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
            }
        }

        function displayFiles(files) {
            const fileListDiv = document.getElementById('fileList');
            
            if (files.length === 0) {
                fileListDiv.innerHTML = '<p>æš‚æ— æ—¥å¿—æ–‡ä»¶</p>';
                updateFileStats(0, 0);
                return;
            }

            const html = files.map(file => `
                <div class="file-item" data-filename="${file.name.toLowerCase()}" data-type="${getFileTypeCategory(file.type)}">
                    <div class="file-info">
                        <div class="file-name">ğŸ“„ ${file.name}</div>
                        <div class="file-meta">
                            å¤§å°: ${formatFileSize(file.size)} | 
                            ä¿®æ”¹æ—¶é—´: ${formatDate(file.lastModified)} | 
                            ç±»å‹: ${file.type} | 
                            ç›®å½•: ${file.directory || 'æ ¹ç›®å½•'}
                        </div>
                    </div>
                    <div class="file-actions">
                        <button class="btn btn-primary" onclick="viewFileDetail('${file.name}')">ğŸ‘ï¸ è¯¦æƒ…</button>
                        <button class="btn btn-success" onclick="downloadFile('${file.name}')">ğŸ“¥ ä¸‹è½½</button>
                        <button class="btn btn-info" onclick="tailFile('${file.name}')">ğŸ”„ å®æ—¶</button>
                    </div>
                </div>
            `).join('');

            fileListDiv.innerHTML = html;
            updateFileStats(files.length, allFiles.length);
        }

        // æ–‡ä»¶æœç´¢å’Œè¿‡æ»¤åŠŸèƒ½
        function filterFiles() {
            const searchTerm = document.getElementById('fileSearchInput').value.toLowerCase();
            applyFilters(searchTerm);
        }

        function filterByType(type) {
            // æ›´æ–°è¿‡æ»¤æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            currentFilter = type;
            const searchTerm = document.getElementById('fileSearchInput').value.toLowerCase();
            applyFilters(searchTerm);
        }

        function applyFilters(searchTerm = '') {
            filteredFiles = allFiles.filter(file => {
                // æ–‡ä»¶åæœç´¢
                const matchesSearch = searchTerm === '' || 
                    file.name.toLowerCase().includes(searchTerm) ||
                    file.directory.toLowerCase().includes(searchTerm);
                
                // ç±»å‹è¿‡æ»¤
                const matchesType = currentFilter === 'all' || 
                    getFileTypeCategory(file.type) === currentFilter;
                
                return matchesSearch && matchesType;
            });
            
            displayFiles(filteredFiles);
        }

        function getFileTypeCategory(fileType) {
            if (fileType.includes('é”™è¯¯')) return 'error';
            if (fileType.includes('ä¿¡æ¯')) return 'info';
            if (fileType.includes('åº”ç”¨')) return 'app';
            return 'other';
        }

        function updateFileStats(displayed, total) {
            const statsElement = document.getElementById('fileStats');
            if (displayed === total) {
                statsElement.textContent = `æ€»è®¡: ${total} ä¸ªæ–‡ä»¶`;
            } else {
                statsElement.textContent = `æ˜¾ç¤º: ${displayed} / ${total} ä¸ªæ–‡ä»¶`;
            }
        }

        // è¯¦æƒ…é¡µé¢åŠŸèƒ½
        function viewFileDetail(fileName) {
            currentFileName = fileName;
            currentPage = 1;
            searchKeyword = '';
            
            // éšè—æ–‡ä»¶åˆ—è¡¨ï¼Œæ˜¾ç¤ºè¯¦æƒ…é¡µé¢
            document.querySelector('.file-list').style.display = 'none';
            document.getElementById('logDetailPage').style.display = 'block';
            document.getElementById('logViewer').style.display = 'none';
            
            // è®¾ç½®æ–‡ä»¶å
            document.getElementById('detailFileName').textContent = fileName;
            
            // æ˜¾ç¤ºæ–‡ä»¶å…ƒæ•°æ®
            displayFileMetadata(fileName);
            
            // åŠ è½½æ–‡ä»¶å†…å®¹
            loadFileContent(fileName, 1, '');
        }

        function displayFileMetadata(fileName) {
            const file = allFiles.find(f => f.name === fileName);
            if (!file) return;
            
            const metadata = document.getElementById('fileMetadata');
            metadata.innerHTML = `
                <div class="metadata-item">
                    <div class="metadata-label">æ–‡ä»¶å</div>
                    <div class="metadata-value">${file.name}</div>
                </div>
                <div class="metadata-item">
                    <div class="metadata-label">æ–‡ä»¶å¤§å°</div>
                    <div class="metadata-value">${formatFileSize(file.size)}</div>
                </div>
                <div class="metadata-item">
                    <div class="metadata-label">ä¿®æ”¹æ—¶é—´</div>
                    <div class="metadata-value">${formatDate(file.lastModified)}</div>
                </div>
                <div class="metadata-item">
                    <div class="metadata-label">æ–‡ä»¶ç±»å‹</div>
                    <div class="metadata-value">${file.type}</div>
                </div>
                <div class="metadata-item">
                    <div class="metadata-label">æ‰€åœ¨ç›®å½•</div>
                    <div class="metadata-value">${file.directory || 'æ ¹ç›®å½•'}</div>
                </div>
                <div class="metadata-item">
                    <div class="metadata-label">å®Œæ•´è·¯å¾„</div>
                    <div class="metadata-value">${file.fullPath || file.name}</div>
                </div>
            `;
        }

        function backToFileList() {
            document.querySelector('.file-list').style.display = 'block';
            document.getElementById('logDetailPage').style.display = 'none';
            document.getElementById('logViewer').style.display = 'none';
            currentFileName = '';
            
            // åœæ­¢è‡ªåŠ¨åˆ·æ–°
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                document.getElementById('autoRefresh').checked = false;
            }
        }

        function refreshCurrentFile() {
            if (currentFileName) {
                loadFileContent(currentFileName, currentPage, searchKeyword);
                showStatus('æ–‡ä»¶å†…å®¹å·²åˆ·æ–°', 'success');
            }
        }

        function toggleViewMode() {
            // åœ¨è¯¦æƒ…é¡µé¢å’Œä¼ ç»ŸæŸ¥çœ‹å™¨ä¹‹é—´åˆ‡æ¢
            const detailPage = document.getElementById('logDetailPage');
            const oldViewer = document.getElementById('logViewer');
            
            if (detailPage.style.display !== 'none') {
                // åˆ‡æ¢åˆ°ä¼ ç»ŸæŸ¥çœ‹å™¨
                detailPage.style.display = 'none';
                oldViewer.style.display = 'block';
                isDetailMode = false;
                
                // é‡æ–°åŠ è½½å†…å®¹åˆ°ä¼ ç»ŸæŸ¥çœ‹å™¨
                viewFile(currentFileName, currentPage, searchKeyword);
            } else {
                // åˆ‡æ¢åˆ°è¯¦æƒ…é¡µé¢
                oldViewer.style.display = 'none';
                detailPage.style.display = 'block';
                isDetailMode = true;
                
                // é‡æ–°åŠ è½½å†…å®¹åˆ°è¯¦æƒ…é¡µé¢
                loadFileContent(currentFileName, currentPage, searchKeyword);
            }
        }

        // åŠ è½½æ–‡ä»¶å†…å®¹ï¼ˆè¯¦æƒ…é¡µé¢ä½¿ç”¨ï¼‰
        async function loadFileContent(fileName, page = 1, search = '') {
            if (!authToken) {
                showStatus('è¯·å…ˆç™»å½•', 'error');
                return;
            }

            try {
                const encodedFileName = fileName.split('/').map(part => encodeURIComponent(part)).join('/');
                const url = `${API_BASE}/view/${encodedFileName}?page=${page}&pageSize=${currentPageSize}&search=${encodeURIComponent(search)}`;
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    displayDetailLogContent(fileName, data);
                    currentPage = page;
                    searchKeyword = search;
                } else if (response.status === 401) {
                    showStatus('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•', 'error');
                    logout();
                } else {
                    const error = await response.text();
                    showStatus(`æŸ¥çœ‹æ–‡ä»¶å¤±è´¥: ${error}`, 'error');
                }
            } catch (error) {
                showStatus(`ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
            }
        }

        // ä¼ ç»ŸæŸ¥çœ‹å™¨ï¼ˆä¿æŒå…¼å®¹æ€§ï¼‰
        async function viewFile(fileName, page = 1, search = '') {
            if (!authToken) {
                showStatus('è¯·å…ˆç™»å½•', 'error');
                return;
            }

            try {
                const encodedFileName = fileName.split('/').map(part => encodeURIComponent(part)).join('/');
                const url = `${API_BASE}/view/${encodedFileName}?page=${page}&pageSize=100&search=${encodeURIComponent(search)}`;
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    displayLogContent(fileName, data);
                    currentFileName = fileName;
                    currentPage = page;
                    searchKeyword = search;
                } else if (response.status === 401) {
                    showStatus('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•', 'error');
                    logout();
                } else {
                    const error = await response.text();
                    showStatus(`æŸ¥çœ‹æ–‡ä»¶å¤±è´¥: ${error}`, 'error');
                }
            } catch (error) {
                showStatus(`ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
            }
        }

        // è¯¦æƒ…é¡µé¢å†…å®¹æ˜¾ç¤º
        function displayDetailLogContent(fileName, data) {
            const logContent = document.getElementById('logContent');
            const pageInfo = document.getElementById('pageInfo');
            const pageJumpInput = document.getElementById('pageJumpInput');

            // é«˜äº®æœç´¢å…³é”®è¯
            let content = data.lines.join('\n');
            if (searchKeyword) {
                const regex = new RegExp(`(${escapeRegExp(searchKeyword)})`, 'gi');
                content = content.replace(regex, '<span class="search-highlight">$1</span>');
            }
            
            logContent.innerHTML = content;
            
            totalPages = data.totalPages || 1;
            pageInfo.textContent = `ç¬¬ ${data.currentPage || 1} é¡µ / å…± ${totalPages} é¡µ (${data.totalLines || 0} è¡Œ)`;
            pageJumpInput.max = totalPages;
            
            // æ»šåŠ¨åˆ°é¡¶éƒ¨
            document.querySelector('.log-content-wrapper').scrollTop = 0;
        }

        // è¯¦æƒ…é¡µé¢åŠŸèƒ½
        function searchInContent() {
            const searchTerm = document.getElementById('contentSearchInput').value;
            searchKeyword = searchTerm;
            loadFileContent(currentFileName, 1, searchTerm);
        }

        function clearContentSearch() {
            document.getElementById('contentSearchInput').value = '';
            searchKeyword = '';
            loadFileContent(currentFileName, currentPage, '');
        }

        function changePageSize() {
            const newPageSize = parseInt(document.getElementById('pageSizeSelect').value);
            currentPageSize = newPageSize;
            loadFileContent(currentFileName, 1, searchKeyword);
        }

        function jumpToPage() {
            const targetPage = parseInt(document.getElementById('pageJumpInput').value);
            if (targetPage >= 1 && targetPage <= totalPages) {
                loadFileContent(currentFileName, targetPage, searchKeyword);
            } else {
                showStatus(`é¡µç å¿…é¡»åœ¨ 1 åˆ° ${totalPages} ä¹‹é—´`, 'error');
            }
        }

        function toggleAutoRefresh() {
            const isEnabled = document.getElementById('autoRefresh').checked;
            
            if (isEnabled) {
                autoRefreshInterval = setInterval(() => {
                    refreshCurrentFile();
                }, 5000); // æ¯5ç§’åˆ·æ–°ä¸€æ¬¡
                showStatus('å·²å¯ç”¨è‡ªåŠ¨åˆ·æ–°ï¼ˆæ¯5ç§’ï¼‰', 'info');
            } else {
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
                showStatus('å·²å…³é—­è‡ªåŠ¨åˆ·æ–°', 'info');
            }
        }

        // å·¥å…·å‡½æ•°
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        function displayLogContent(fileName, data) {
            const logViewer = document.getElementById('logViewer');
            const currentFileSpan = document.getElementById('currentFile');
            const logContent = document.getElementById('logContentOld');
            const pageInfo = document.getElementById('pageInfoOld');

            currentFileSpan.textContent = `å½“å‰æ–‡ä»¶: ${fileName}`;
            logContent.textContent = data.lines.join('\n');
            
            totalPages = data.totalPages || 1;
            pageInfo.textContent = `ç¬¬ ${data.currentPage || 1} é¡µ / å…± ${totalPages} é¡µ (${data.totalLines || 0} è¡Œ)`;

            logViewer.style.display = 'block';
            logViewer.scrollIntoView({ behavior: 'smooth' });
        }

        async function downloadFile(fileName) {
            if (!authToken) {
                showStatus('è¯·å…ˆç™»å½•', 'error');
                return;
            }

            try {
                // å¯¹äºå­ç›®å½•è·¯å¾„ï¼Œä¸è¦å¯¹æ–œæ è¿›è¡Œç¼–ç 
                const encodedFileName = fileName.split('/').map(part => encodeURIComponent(part)).join('/');
                const response = await fetch(`${API_BASE}/download/${encodedFileName}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = fileName;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    showStatus(`æ–‡ä»¶ ${fileName} ä¸‹è½½æˆåŠŸ`, 'success');
                } else if (response.status === 401) {
                    showStatus('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•', 'error');
                    logout();
                } else {
                    const error = await response.text();
                    showStatus(`ä¸‹è½½æ–‡ä»¶å¤±è´¥: ${error}`, 'error');
                }
            } catch (error) {
                showStatus(`ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
            }
        }

        async function tailFile(fileName) {
            if (!authToken) {
                showStatus('è¯·å…ˆç™»å½•', 'error');
                return;
            }

            try {
                // å¯¹äºå­ç›®å½•è·¯å¾„ï¼Œä¸è¦å¯¹æ–œæ è¿›è¡Œç¼–ç 
                const encodedFileName = fileName.split('/').map(part => encodeURIComponent(part)).join('/');
                const response = await fetch(`${API_BASE}/tail/${encodedFileName}?lines=50`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    displayLogContent(fileName, {
                        lines: data.lines,
                        currentPage: 1,
                        totalPages: 1,
                        totalLines: data.actualLines
                    });
                    showStatus(`æ˜¾ç¤º ${fileName} çš„æœ€æ–° ${data.actualLines} è¡Œ`, 'success');
                } else if (response.status === 401) {
                    showStatus('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•', 'error');
                    logout();
                } else {
                    const error = await response.text();
                    showStatus(`è·å–å®æ—¶æ—¥å¿—å¤±è´¥: ${error}`, 'error');
                }
            } catch (error) {
                showStatus(`ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
            }
        }

        function downloadCurrentFile() {
            if (currentFileName) {
                downloadFile(currentFileName);
            }
        }

        function closeLogViewer() {
            document.getElementById('logViewer').style.display = 'none';
            currentFileName = '';
        }

        function previousPage() {
            if (currentPage > 1) {
                if (isDetailMode && document.getElementById('logDetailPage').style.display !== 'none') {
                    loadFileContent(currentFileName, currentPage - 1, searchKeyword);
                } else {
                    viewFile(currentFileName, currentPage - 1, searchKeyword);
                }
            }
        }

        function nextPage() {
            if (currentPage < totalPages) {
                if (isDetailMode && document.getElementById('logDetailPage').style.display !== 'none') {
                    loadFileContent(currentFileName, currentPage + 1, searchKeyword);
                } else {
                    viewFile(currentFileName, currentPage + 1, searchKeyword);
                }
            }
        }

        function searchLogs() {
            const search = document.getElementById('searchInput').value;
            if (currentFileName) {
                viewFile(currentFileName, 1, search);
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleString('zh-CN');
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„è®¤è¯ä¿¡æ¯
            checkStoredAuth();
            
            // å¦‚æœæ²¡æœ‰è‡ªåŠ¨ç™»å½•ï¼Œæ˜¾ç¤ºç™»å½•æç¤ºå¹¶è·å–éªŒè¯ç 
            if (!authToken) {
                showStatus('è¯·ç™»å½•ä»¥æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶', 'info');
                refreshVerificationCode();
            }
            
            // æ·»åŠ å›è½¦é”®ç™»å½•æ”¯æŒ
            document.getElementById('verificationCodeInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    login();
                }
            });
            
            document.getElementById('passwordInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('verificationCodeInput').focus();
                }
            });
            
            document.getElementById('usernameInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('passwordInput').focus();
                }
            });
        });
    </script>
</body>
</html> 